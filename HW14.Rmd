---
title: 'MSCS 264: Homework #14'
subtitle: ' Paul Martinuzzi '
output:
  pdf_document:
    keep_tex: yes
    latex_engine: xelatex
---
```{r, setup, include=FALSE}
library(tidyverse)
library(stringr)
library(rvest)
library(nycflights13)
library(ggrepel)
```

1. Read in the table of data found at this link: <https://en.wikipedia.org/wiki/List_of_United_States_cities_by_population> and create a scatterplot of land area versus the 2018 estimated population. Identify and label any outlier cities using `geom_label_repel()`. Additionally, do necessary tidying: get rid of extraneous information in the cells, parse columns into the proper format, etc.  A few things to look for:


#tibble2 is tidy, I just labeled the columns in tibble1 that I was going to actually use later on. To skip output in this chunk go to page 29.

```{r, echo}
link <- read_html("https://en.wikipedia.org/wiki/List_of_United_States_cities_by_population")
tables <- html_nodes(link, css = "table")
html_table(tables, header = TRUE, fill = TRUE)
tables_data <- html_table(tables, header = FALSE, fill = TRUE)[[5]]

tibble1<-as_tibble(tables_data) %>%
filter(row_number() != 1) %>%
rename("city" = X2, "estimate" = X4, "landarea_mi2"= X7)
```
```{r}
tibble2 <- tibble1 %>%
select(city,estimate,landarea_mi2) %>%
mutate(estimate = parse_number(estimate),
landarea_mi2 = parse_number(landarea_mi2),
city = str_replace_all(city, "\\[.\\]", ""))%>%
arrange(desc(landarea_mi2))

####
outliertib<-tibble2 %>%
filter(landarea_mi2>= 715)
outliertib
####

ggplot(tibble2, mapping=aes(x=landarea_mi2, y=estimate))+
geom_point()+
labs(title="Area of land mi^2 by est pop 2018", x = "Area of land (miles^2)",
y = "Estimated Pop. 2018")+
geom_label_repel(mapping = aes(label = city), color="red",
data = outliertib)
```


2. Following the examples from class, use the `rvest` package to pull off data from the link  <https://www.imdb.com/search/title?year=2018-01-01,2018-12-31&sort=boxoffice_gross_us,desc> with the top 50 grossing films from 2018. Generate a tibble that contains the title, gross, star rating (imdbscore), and metascore for the top 50 films. Then create a scatterplot of star rating versus Gross and label any outlying films.  A couple of hints:

```{r}
#call html
movies <- read_html("https://www.imdb.com/search/title/?year=2018-01-01,2018-12-31&sort=boxoffice_gross_us,desc")

#load in title of movie
title_data_html<-html_nodes(movies, '.lister-item-header a')
title<- html_text(title_data_html)
head(title)

#load in gross data of movie
gross_data_html<-html_nodes(movies, '.ghost~ .text-muted+ span')
gross<-html_text(gross_data_html)
gross<-parse_number(gross)

#load in star rating of movie
starrating_data_html<-html_nodes(movies, '.ratings-imdb-rating strong')
starrating<-html_text(starrating_data_html)
starrating<-parse_number(starrating)

#load in metascore rating of movie
metascore_data_html<-html_nodes(movies,'.metascore')
metascore<-html_text(metascore_data_html)
metascore<-parse_number(metascore)
```

```{r}
#combine 4 columns into one tibble
top50<-tibble(title, gross, starrating, metascore)

####
#find outliers
outliertib <- top50 %>%
filter(starrating < 4)
####

#plot results
ggplot(top50, mapping=aes(x=starrating, y=gross))+
geom_point()+
geom_label_repel(mapping = aes(label = title), color="red", data = outliertib, nudge_y = 5)+
labs(title="Gross ($) by Star Rating, Top 50 Movies", y="Gross($)", x= "Star Rating")
```

3. Identify which films of the top 50 from 2018 had the biggest discprenacy between reviewers (metascore) and viewers (star rating).
```{r}
disc <- top50 %>% 
  mutate(starrating = starrating * 10) %>% mutate(discrep = abs(metascore - starrating)) %>% 
  mutate(discrep = discrep) %>%
arrange(desc(discrep))

#Top 5 most discrepant movies in top 50
head(disc, n=5)
```

#Top 5 most discrepant movies in top 50
#head(disc, n=5)

#  title                  gross starrating metascore discrep

#  <chr>                  <dbl>      <dbl>     <dbl>   <dbl>

#1 I Can Only Imagine      83.5         74        30      44

#2 Venom                  214.          67        35      32

#3 Bohemian Rhapsody      216.          80        49      31

#4 Avengers: Infinity War 679.          85        68      17

#5 The Equalizer 2        102.          67        50      17


4. 5 points if you push your Rmd file with HW14 solutions along with the knitted pdf file to your MSCS264-HW14 repository in your GitHub account.  So that I can check, make your repository private (good practice when doing HW), but add me (username = slanegetaz) as a collaborator under Settings > Collaborators.

#I added my solutions and you to my private repository: my username is PaulMartinuzzi.

## Factors

*5. In the `nycflights13` data, just consider flights to O'Hare (dest=="ORD"), and summarize the mean arrival delay by carrier.  Use the entire name of the carrier after merging carrier names into `flights`.  Then use `geom_point` to plot mean arrival delay vs. carrier -- first without reordering carrier names, and second after reordering carrier names by mean arrival delay.
```{r}
library(nycflights13)
flights <- flights
airlines <- airlines

flights1 <- flights %>% filter(dest=="ORD", is.na(arr_delay)==FALSE) %>% group_by(carrier)%>% summarise(meanarrdel=mean(arr_delay))
```
```{r}
lefty <- left_join(flights1, airlines, by = c("carrier", "carrier"))
```

```{r}
ggplot(lefty, aes(x=carrier, y=meanarrdel))+
  geom_point()+
  labs(title="NOT reordered by carrier mean arrival del")

lefty2 <- lefty%>%
  mutate(carrier = fct_reorder(carrier, meanarrdel))

ggplot(lefty2, aes(x=carrier, y=meanarrdel))+
  geom_point()+
  labs(title="Reordered by carrier mean arrival del")
```

*6. Again considering only flights to O'Hare, use `fct_collapse()` create a new factor variable which differentiates national carriers (American and United) from regional carriers (all other which fly to O'Hare).  Then create a density plot comparing arrival delays for all flights to O'Hare from those two groups (you might want to exclude arrival delays over a certain level).
```{r}
flightsfin <- flights %>% filter(dest=="ORD")
```
```{r}
flightstype <- flightsfin %>%
  mutate(carriertype = fct_collapse(carrier,
                                National = c("UA", "AA"),
                                Regional = c("MQ", "B6", "9E", "OO", "EV")))
```

```{r}
ggplot(flightstype, aes(x=arr_delay)) + geom_density()+
  facet_wrap(~carriertype)+
  xlim(0,300)+
  ggtitle("Arrival delay to ohare by carrier type")
```

